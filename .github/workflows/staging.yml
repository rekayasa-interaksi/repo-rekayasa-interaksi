name: Build Staging
on:
  push:
    branches: [release]

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: staging
    steps:
      - name: Deploy
        uses: appleboy/ssh-action@v0.1.2
        with:
          host: ${{secrets.SSH_HOST}}
          key: ${{secrets.SSH_KEY}}
          username: ${{secrets.SSH_USERNAME}}
          script: |
            cd /opt/provey/project/fe-dashboard-admin
            source ~/.bash_profile
            nvm use 18
            git fetch --all
            git checkout origin/release
            
            # Build new Docker image with environment variables
            docker build --no-cache -f Dockerfile -t staging-fe-dashboard-admin:new \
            --build-arg VITE_BASE_URL=${{vars.VITE_BASE_URL}} \
            --build-arg VITE_BUCKET_BASE_URL=${{vars.VITE_BUCKET_BASE_URL}} .

            # Start new container on temporary port
            docker run -d -p 3026:80 --name staging-fe-dashboard-admin-new staging-fe-dashboard-admin:new
            
            # Wait for container to start up (adjust sleep time as needed)
            sleep 10
            
            # Basic health check
            if curl -s http://localhost:3026 > /dev/null; then
              # Stop and remove old container
              docker rm -f staging-fe-dashboard-admin || true
              
              # Start new container with production port
              docker run -d -p 3027:80 --name staging-fe-dashboard-admin staging-fe-dashboard-admin:new
              
              # Clean up temporary container
              docker rm -f staging-fe-dashboard-admin-new
              
              echo 'Deployment successful!'
              exit 0
            else
              # If health check fails, clean up and exit with error
              docker rm -f staging-fe-dashboard-admin-new
              echo 'Deployment failed - new container health check failed'
              exit 1
            fi
